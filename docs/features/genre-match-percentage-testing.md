# План тестирования обновления расчета совпадения жанров

## Тестовые сценарии

### 1. Тест на идеальное совпадение вкусов

**Данные:**
- Пользователь A: Action=90, Comedy=70, Drama=60
- Пользователь B: Action=88, Comedy=72, Drama=62

**Ожидаемый результат:**
- Все жанры имеют разницу ≤ 0.4 (0.02, 0.02, 0.02)
- % совпадения: 3/3 = 100%

**Как тестировать:**
1. Открыть `/profile/taste-map/compare/[userId]`
2. Проверить "Жанры - Совпадение предпочитаемых жанров фильмов"
3. Должно показать: **100%**

---

### 2. Тест на разные вкусы

**Данные:**
- Пользователь A: Action=90, Comedy=10
- Пользователь B: Action=10, Comedy=90

**Ожидаемый результат:**
- Action: |0.90 - 0.10| = 0.80 > 0.4 ✗
- Comedy: |0.10 - 0.90| = 0.80 > 0.4 ✗
- % совпадения: 0/2 = 0%

**Как тестировать:**
1. Создать пользователей с противоположными предпочтениями
2. Посмотреть Action и Comedy фильмы с разными оценками
3. Открыть страницу сравнения
4. Должно показать: **0%**

---

### 3. Тест на граничное значение (exactly 0.4)

**Данные:**
- Пользователь A: Action=80
- Пользователь B: Action=40

**Ожидаемый результат:**
- Разница: |0.80 - 0.40| = 0.40 ≤ 0.4 ✓
- % совпадения: 1/1 = 100%

**Как тестировать:**
1. Найти/создать пользователей с точно такой разницей
2. Проверить результат
3. Должно показать: **100%** (граница включена)

---

### 4. Тест на объединение жанров (union)

**Данные:**
- Пользователь A: Action=80, Comedy=70
- Пользователь B: Action=82, Drama=75

**Ожидаемый результат:**
- Union: Action, Comedy, Drama (3 жанра)
- Action: diff 0.02 ✓
- Comedy: diff |0.70 - 0.00| = 0.70 > 0.4 ✗
- Drama: diff |0.00 - 0.75| = 0.75 > 0.4 ✗
- % совпадения: 1/3 ≈ 33%

**Как тестировать:**
1. У одного пользователя: Action + Comedy
2. У другого: Action + Drama
3. Открыть сравнение
4. Должно показать: **~33%**

---

### 5. Тест на новую логику vs старую (cosine similarity)

**Старая логика:**
- Использовала только общие жанры
- Вычисляла угол между векторами

**Новая логика:**
- Использует все жанры (union)
- Проверяет разницу оценок по порогу 0.4

**Как проверить:**
1. Открыть страницу сравнения двух пользователей
2. Проверить, что тестовые сценарии 1-4 дают ожидаемые результаты
3. Если есть старые данные - они должны пересчитаться по новой логике

---

### 6. Интеграционный тест

**Проверяемые компоненты:**
- API: `/api/user/taste-map-comparison/[userId]` возвращает новое `tasteSimilarity`
- Страница: Отображает % корректно
- Метрика: Используется в расчете общего совпадения (`overallMatch`)

**Как тестировать:**
```bash
# 1. Сделать запрос к API
curl 'http://localhost:3000/api/user/taste-map-comparison/[comparedUserId]' \
  -H 'Cookie: [auth cookies]'

# 2. Проверить в JSON response:
# - metrics.tasteSimilarity должно быть 0-1
# - metrics.overallMatch должно учитывать новую tasteSimilarity

# 3. Открыть UI и проверить визуальное отображение
```

---

## Проверка кэширования

**Важно:** Redis кэш НЕ нужно очищать вручную

- Similarity вычисляется свежей каждый раз при загрузке страницы
- Taste maps кэшируются на 24 часа (это отдельное кэширование)
- Новая логика применяется автоматически

---

## Откат (если потребуется)

Если понадобится вернуть старую логику `cosineSimilarity`:

```typescript
// В src/lib/taste-map/similarity.ts функция computeSimilarity
// Вернуть:
const tasteSimilarity = cosineSimilarity(
  tasteMapA.genreProfile,
  tasteMapB.genreProfile
);
```

Код старой функции `cosineSimilarity` остается в файле и может быть восстановлен.

---

## Метрики для мониторинга

После развертывания следить за:
1. **Средний % совпадения** - должен быть разумным (20-80% для большинства)
2. **Распределение %** - не должны все быть 0% или 100%
3. **Корреляция с другими метриками** - должна быть логичная связь между жанрами и рейтингами
4. **Производительность** - функция O(n) по количеству жанров (обычно < 50)
