name: Database Backup to Yandex Disk

on:
  schedule:
    # Run daily at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL 17 client
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg2 lsb-release curl gzip
          wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

          echo "=== PostgreSQL Version ==="
          /usr/lib/postgresql/17/bin/pg_dump --version

      - name: Check DATABASE_URL
        run: |
          if [ "${{ secrets.DATABASE_URL }}" == "" ]; then
            echo "ERROR: DATABASE_URL secret is not set!"
            exit 1
          fi
          echo "DATABASE_URL is configured"

      - name: Create database backup
        id: create-backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FILENAME="cinechance_backup_${TIMESTAMP}.sql.gz"

          echo "=== Creating backup ==="
          echo "Timestamp: $TIMESTAMP"
          echo "Output: $FILENAME"

          # Create compressed dump
          /usr/lib/postgresql/17/bin/pg_dump "${{ secrets.DATABASE_URL }}" \
            --clean \
            --if-exists \
            --no-owner \
            --no-privileges \
            2>&1 | gzip > "$FILENAME"

          # Verify file
          if [ -f "$FILENAME" ]; then
            SIZE=$(stat -c%s "$FILENAME")
            echo "File created: $FILENAME ($SIZE bytes)"
            if [ $SIZE -gt 100 ]; then
              echo "Backup size OK"
            else
              echo "WARNING: Backup file too small!"
              exit 1
            fi
          else
            echo "ERROR: Backup file not created!"
            exit 1
          fi

          echo "backup_file=$FILENAME" >> $GITHUB_OUTPUT
          echo "backup_size=$SIZE" >> $GITHUB_OUTPUT

      - name: Create folder on Yandex Disk
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FOLDER_PATH="/CineChanceBackups"

          echo "=== Creating folder $FOLDER_PATH ==="
          curl -X PUT \
            -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH" \
            -s -w "\nHTTP Status: %{http_code}\n" || echo "Folder may already exist"

      - name: Upload backup to Yandex Disk
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FILENAME="${{ steps.create-backup.outputs.backup_file }}"
          DEST_PATH="/CineChanceBackups/$FILENAME"

          echo "=== Uploading $FILENAME to Yandex Disk ==="

          # Step 1: Get upload URL
          echo "Getting upload URL..."
          UPLOAD_RESPONSE=$(curl -X GET \
            -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources/upload?path=$DEST_PATH")

          UPLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"href":"[^"]*"' | cut -d'"' -f4)

          if [ -z "$UPLOAD_URL" ]; then
            echo "ERROR: Could not get upload URL"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          fi

          # Step 2: Upload file
          echo "Uploading..."
          UPLOAD_STATUS=$(curl -X PUT \
            --data-binary @"$FILENAME" \
            "$UPLOAD_URL" \
            -w "%{http_code}" -o /dev/null)

          if [ "$UPLOAD_STATUS" = "201" ]; then
            echo "SUCCESS: Backup uploaded to Yandex Disk!"
            echo "Location: Yandex Disk$CineChanceBackups/$FILENAME"
          else
            echo "ERROR: Upload failed with status $UPLOAD_STATUS"
            exit 1
          fi

      - name: Clean old backups (keep last 30 days)
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FOLDER_PATH="/CineChanceBackups"
          DAYS_TO_KEEP=30

          echo "=== Cleaning old backups (keep last $DAYS_TO_KEEP days) ==="

          # Get list of files in folder
          FILES_JSON=$(curl -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH" \
            -s)

          # Extract file names and dates
          echo "$FILES_JSON" | grep -o '"name":"[^"]*\.sql\.gz"' | while read line; do
            FILENAME=$(echo "$line" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)

            # Get file metadata
            FILE_JSON=$(curl -H "Authorization: OAuth $TOKEN" \
              "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH/$FILENAME" \
              -s)

            # Extract created date
            CREATED_AT=$(echo "$FILE_JSON" | grep -o '"created":"[^"]*"' | cut -d'"' -f4)

            if [ -n "$CREATED_AT" ]; then
              # Convert to timestamp
              FILE_DATE=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -u -d "$CREATED_AT" +%s 2>/dev/null)
              CURRENT_DATE=$(date +%s)
              DAYS_OLD=$(( (CURRENT_DATE - FILE_DATE) / 86400 ))

              if [ $DAYS_OLD -gt $DAYS_TO_KEEP ]; then
                echo "Deleting $FILENAME (${DAYS_OLD} days old)"
                curl -X DELETE \
                  -H "Authorization: OAuth $TOKEN" \
                  "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH/$FILENAME" \
                  -s -w " => HTTP %{http_code}\n"
              else
                echo "Keeping $FILENAME (${DAYS_OLD} days old)"
              fi
            fi
          done

      - name: Verify backup on Yandex Disk
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FILENAME="${{ steps.create-backup.outputs.backup_file }}"

          echo "=== Verifying backup ==="
          curl -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=/CineChanceBackups" \
            -s | grep -o "\"name\":\"[^\"]*\"" | grep "$FILENAME" && \
            echo "VERIFIED: File found on Yandex Disk!" || echo "WARNING: File not found in listing"
