name: Test Yandex Disk API

on:
  workflow_dispatch

jobs:
  test-yandex-disk:
    runs-on: ubuntu-latest

    steps:
      - name: Create test file
        run: |
          echo "Test from GitHub Actions - $(date)" > test_file.txt
          echo "Timestamp: $(date +%Y%m%d_%H%M%S)" >> test_file.txt
          cat test_file.txt

      - name: Create folder on Yandex Disk
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FOLDER_PATH="/CineChanceBackups"

          echo "=== Creating folder $FOLDER_PATH ==="
          curl -X PUT \
            -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Upload file to folder
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FILENAME="test_file.txt"
          DEST_PATH="/CineChanceBackups/test_file.txt"

          echo "=== Uploading $FILENAME to $DEST_PATH ==="
          curl -X PUT \
            -H "Authorization: OAuth $TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$FILENAME" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$DEST_PATH" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Verify file exists
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"

          echo "=== List files in /CineChanceBackups ==="
          curl -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=/CineChanceBackups" \
            2>/dev/null | grep -o '"name":"[^"]*"' | head -5
