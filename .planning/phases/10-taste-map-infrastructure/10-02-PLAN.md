---
phase: 10-taste-map-infrastructure
plan: "02"
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/taste-map/similarity.ts
autonomous: true
requirements: []
user_setup: []

must_haves:
  truths:
    - "Cosine similarity function correctly computes vector similarity (0-1 scale)"
    - "Rating correlation function computes Pearson correlation between users"
    - "Person overlap function computes Jaccard similarity of favorite persons"
    - "Overall match combines all metrics with correct weights (0.5, 0.3, 0.2)"
    - "Similar users list stored in Redis with 24h TTL under correct key pattern"
    - "Similarity threshold > 0.7 correctly identifies similar users"
  artifacts:
    - path: "src/lib/taste-map/similarity.ts"
      provides: "Similarity calculation functions: cosineSimilarity, ratingCorrelation, personOverlap, computeOverallMatch, findSimilarUsers"
      exports: ["cosineSimilarity", "ratingCorrelation", "personOverlap", "SimilarityResult", "computeOverallMatch", "isSimilar", "findSimilarUsers", "getSimilarUsers", "storeSimilarUsers", "storeSimilarityPair", "getSimilarityPair"]
  key_links:
    - from: "src/lib/taste-map/similarity.ts"
      to: "src/lib/taste-map/types.ts"
      via: "import"
      pattern: "import.*TasteMap"
    - from: "src/lib/taste-map/similarity.ts"
      to: "src/lib/taste-map/redis.ts"
      via: "import and function calls"
      pattern: "import.*redis"
---

<objective>
Implement similarity calculation between users for finding similar users based on Taste Map profiles.
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-taste-map-infrastructure/10-CONTEXT.md
@.planning/phases/10-taste-map-infrastructure/10-RESEARCH.md
@src/lib/taste-map/types.ts
@src/lib/taste-map/redis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cosine similarity and vector normalization</name>
  <files>src/lib/taste-map/similarity.ts</files>
  <action>
Create `src/lib/taste-map/similarity.ts` with:

1. `SimilarityResult` interface:
   ```typescript
   interface SimilarityResult {
     tasteSimilarity: number;     // Cosine similarity (0-1)
     ratingCorrelation: number;   // Pearson correlation (-1 to 1)
     personOverlap: number;        // Jaccard similarity (0-1)
     overallMatch: number;        // Weighted sum (0-1)
   }
   ```

2. `cosineSimilarity(profileA, profileB)`: Pure function implementing formula from RESEARCH.md:
   - Normalize both profiles to same genre set
   - Compute dot product and magnitudes
   - Return dotProduct / (magnitudeA * magnitudeB)
   - Handle edge cases: empty profiles return 0, division by zero returns 0

3. Helper function: `normalizeVectors(profileA, profileB)` to align different genre sets.
</action>
  <verify>File exists, TypeScript compiles, cosine similarity returns 0-1 for identical vectors</verify>
  <done>Cosine similarity function ready for genre profile comparison</done>
</task>

<task type="auto">
  <name>Task 2: Implement rating correlation and person overlap</name>
  <files>src/lib/taste-map/similarity.ts</files>
  <action>
Extend `src/lib/taste-map/similarity.ts`:

1. `ratingCorrelation(ratingsA, ratingsB)`: Compute Pearson correlation coefficient
   - Input: arrays of ratings (both users rated same movies)
   - Output: -1 to 1 (1 = perfect positive correlation)
   - Handle edge cases: insufficient data returns 0

2. `personOverlap(personsA, personsB)`: Compute Jaccard similarity
   - Input: two Record<string, number> (person profiles)
   - Convert to sets of person names
   - Return |intersection| / |union|
   - Handle edge cases: empty profiles return 0
</action>
  <verify>TypeScript compiles, functions handle edge cases correctly</verify>
  <done>Rating correlation and person overlap functions available</done>
</task>

<task type="auto">
  <name>Task 3: Implement overall match and find similar users</name>
  <files>src/lib/taste-map/similarity.ts</files>
  <action>
Extend `src/lib/taste-map/similarity.ts`:

1. `computeOverallMatch(result: SimilarityResult)`: Weighted sum with weights from CONTEXT.md:
   - tasteSimilarity: 0.5
   - ratingCorrelation: 0.3
   - personOverlap: 0.2

2. `isSimilar(result: SimilarityResult)`: Returns true if tasteSimilarity > 0.7 (threshold from CONTEXT.md)

3. Redis storage functions:
   - `storeSimilarUsers(userId, similarUserIds)`: stores to `similar-users:{userId}` with 24h TTL
   - `getSimilarUsers(userId)`: retrieves from cache or computes fresh
   - `storeSimilarityPair(userId, otherUserId, score)`: stores individual pair similarity to `similarity:{userId}:{otherUserId}` with 24h TTL
   - `getSimilarityPair(userId, otherUserId)`: retrieves pair similarity score from Redis

4. `findSimilarUsers(userId, candidateUserIds)`: 
   - For each candidate, compute full SimilarityResult
   - Filter to only those where isSimilar() returns true
   - Store results to Redis
   - Return array of { userId, overallMatch }

5. `getSimilarUsersWithScores(userId)`: Retrieve similar users with their match scores from Redis.
</action>
  <verify>All functions exported, Redis keys match pattern from CONTEXT.md: similar-users:{userId}</verify>
  <done>Similarity calculation and Redis storage complete</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] All exports available from similarity.ts
- [ ] Redis keys match: `similar-users:{userId}`, `similarity:{userId}:{otherUserId}`
- [ ] Threshold > 0.7 for tasteSimilarity correctly identifies similar users
- [ ] Weights correct: 0.5, 0.3, 0.2 for overall match
</verification>

<success_criteria>
Similarity calculation infrastructure complete. Other modules can import and use similarity functions to find similar users.
</success_criteria>

<output>
After completion, create `.planning/phases/10-taste-map-infrastructure/10-02-SUMMARY.md`
</output>
