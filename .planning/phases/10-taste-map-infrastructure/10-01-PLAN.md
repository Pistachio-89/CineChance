---
phase: 10-taste-map-infrastructure
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/taste-map/types.ts
  - src/lib/taste-map/compute.ts
  - src/lib/taste-map/redis.ts
autonomous: true
requirements: []
user_setup: []

must_haves:
  truths:
    - "TasteMap type definitions exist with all required fields from CONTEXT"
    - "Genre profile stored in Redis with 24h TTL under correct key pattern"
    - "Person profile stored in Redis with 24h TTL under correct key pattern"
    - "Type profile stored in Redis with 24h TTL under correct key pattern"
    - "Computed metrics (positiveIntensity, negativeIntensity, consistency, diversity) available"
    - "Background recomputation triggered via Next.js after() without blocking response"
  artifacts:
    - path: "src/lib/taste-map/types.ts"
      provides: "TypeScript interfaces for TasteMap, GenreProfile, PersonProfile, BehaviorProfile, ComputedMetrics"
      exports: ["TasteMap", "GenreProfile", "PersonProfile", "BehaviorProfile", "ComputedMetrics", "RatingDistribution"]
    - path: "src/lib/taste-map/redis.ts"
      provides: "Redis storage helpers using withCache with 24h TTL"
      exports: ["storeTasteMap", "getTasteMap", "storeGenreProfile", "getGenreProfile", "storePersonProfile", "getPersonProfile", "storeTypeProfile", "getTypeProfile", "invalidateTasteMap"]
    - path: "src/lib/taste-map/compute.ts"
      provides: "Core computation functions for building profiles from watched movies"
      exports: ["computeTasteMap", "computeGenreProfile", "computePersonProfile", "computeTypeProfile", "computeBehaviorProfile", "computeMetrics"]
  key_links:
    - from: "src/lib/taste-map/compute.ts"
      to: "prisma.watchList"
      via: "Prisma query"
      pattern: "prisma\\.watchList\\.findMany"
    - from: "src/lib/taste-map/redis.ts"
      to: "src/lib/redis.ts"
      via: "withCache import"
      pattern: "withCache"
---

<objective>
Create TasteMap data structure and Redis storage infrastructure for computing/storing user preference profiles.
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-taste-map-infrastructure/10-CONTEXT.md
@.planning/phases/10-taste-map-infrastructure/10-RESEARCH.md
@src/lib/redis.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TasteMap type definitions</name>
  <files>src/lib/taste-map/types.ts</files>
  <action>
Create TypeScript interfaces matching CONTEXT.md locked decisions:

1. Create `src/lib/taste-map/types.ts` with exports:
   - `RatingDistribution`: { high: number, medium: number, low: number } (percentages)
   - `BehaviorProfile`: { rewatchRate: number, dropRate: number, completionRate: number } (percentages)
   - `ComputedMetrics`: { positiveIntensity: number, negativeIntensity: number, consistency: number, diversity: number }
   - `PersonProfiles`: { actors: Record<string, number>, directors: Record<string, number> }
   - `TasteMap`: { userId: string, genreProfile: Record<string, number>, ratingDistribution: RatingDistribution, averageRating: number, personProfiles: PersonProfiles, behaviorProfile: BehaviorProfile, computedMetrics: ComputedMetrics, updatedAt: Date }

All numeric values: 0-100 scale for profiles, 0-10 for averageRating. Use explicit types (not `any`).
  </action>
  <verify>File exists, TypeScript compiles without errors</verify>
  <done>TasteMap interfaces exported and usable by other modules</done>
</task>

<task type="auto">
  <name>Task 2: Create Redis storage helpers</name>
  <files>src/lib/taste-map/redis.ts</files>
  <action>
Create Redis storage helpers in `src/lib/taste-map/redis.ts`:

1. Import `withCache` from `@/lib/redis`
2. Define `TTL_24H = 86400` (from RESEARCH.md)
3. Create storage functions using existing withCache pattern:
   - `storeTasteMap(userId, data)`: stores to `user:{userId}:taste-map`
   - `getTasteMap(userId)`: retrieves from cache or computes fresh
   - `storeGenreProfile(userId, profile)`: stores to `user:{userId}:genre-profile`
   - `getGenreProfile(userId)`: retrieves or computes
   - `storePersonProfile(userId, profile)`: stores to `user:{userId}:person-profile`
   - `getPersonProfile(userId)`: retrieves or computes
   - `storeTypeProfile(userId, profile)`: stores to `user:{userId}:type-profile`
   - `getTypeProfile(userId)`: retrieves or computes
   - `invalidateTasteMap(userId)`: invalidates all taste-map keys for user

Use key patterns from CONTEXT.md: `user:{userId}:*` with 24h TTL.
  </action>
  <verify>File exists, all functions exported, uses existing withCache pattern from redis.ts</verify>
  <done>Redis storage helpers with 24h TTL working for all profile types</done>
</task>

<task type="auto">
  <name>Task 3: Create core computation functions</name>
  <files>src/lib/taste-map/compute.ts</files>
  <action>
Create core computation functions in `src/lib/taste-map/compute.ts`:

1. Import types from `./types`
2. Import prisma from `@/lib/prisma`
3. Implement functions:
   - `computeGenreProfile(watchedMovies)`: aggregates ratings by genre, returns Record<string, number> (0-100 scale)
   - `computePersonProfile(watchedMovies, credits)`: aggregates ratings by actor/director from TMDB credits, returns { actors, directors }
   - `computeTypeProfile(watchedMovies)`: aggregates by mediaType (movie/tv), returns percentages
   - `computeBehaviorProfile(watchedMovies, allUserItems)`: calculates rewatchRate, dropRate, completionRate from WatchList data
   - `computeMetrics(genreProfile, ratingDistribution)`: calculates positiveIntensity, negativeIntensity, consistency, diversity
   - `computeRatingDistribution(watchedMovies)`: calculates percentage of ratings in each bucket: high (8-10), medium (5-7), low (1-4)
   - `computeTasteMap(userId)`: main function that queries WatchList, fetches TMDB credits, computes all profiles, returns TasteMap
   - `recomputeTasteMap(userId)`: wrapper that computes and stores to Redis

Query WatchList for user items with status: 'watched' or completed statuses. Use Prisma to fetch relevant data.
  </action>
  <verify>File exists, functions import types correctly, no TypeScript errors</verify>
  <done>Core computation functions export available for similarity calculation</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors for all created files
- [ ] All exports from types.ts match CONTEXT.md data structure
- [ ] Redis keys match pattern from CONTEXT.md: user:{userId}:taste-map, genre-profile, person-profile, type-profile
- [ ] TTL is 24h (86400 seconds) for all keys
</verification>

<success_criteria>
TasteMap infrastructure ready: types defined, Redis storage working, computation functions available for Phase 10-02.
</success_criteria>

<output>
After completion, create `.planning/phases/10-taste-map-infrastructure/10-01-SUMMARY.md`
</output>
