---
phase: 06-stats-page
plan: '03'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/user/stats/route.ts
autonomous: true
requirements: []
gap_closure: true
must_haves:
  truths:
    - API filtering works correctly for cartoon/anime types
    - When filtering by Аниме, averageRating shows only anime ratings
    - When filtering by Мультфильмы, averageRating shows only cartoon ratings
    - ratingDistribution correctly filters by content type
  artifacts:
    - path: src/app/api/user/stats/route.ts
      provides: Stats API with proper cartoon/anime filtering
      contains: getMediaTypeCondition handles all 4 types correctly
  key_links:
    - from: StatsClient.tsx
      to: /api/user/stats
      via: fetch with ?media= param
      pattern: typeFilter
---

<objective>
Fix API filtering for cartoon/anime types in /api/user/stats.

Purpose: The current getMediaTypeCondition() only handles movie/tv. For cartoon/anime it returns empty object {}, causing DB queries to return all records. Fix this so filtering works for all 4 content types.

Output: Updated route.ts with proper cartoon/anime filtering.
</objective>

<context>
@src/app/api/user/stats/route.ts (file to fix)
</context>

<tasks>

<task type="auto">
  <name>Fix getMediaTypeCondition for cartoon/anime</name>
  <files>src/app/api/user/stats/route.ts</files>
  <action>
Fix the getMediaTypeCondition function to handle all 4 content types:

Current buggy code (around line 63-71):
```
function getMediaTypeCondition(mediaType: string) {
  if (mediaType === 'movie' || mediaType === 'tv') {
    return { mediaType };
  }
  return {};  // BUG: No filter for cartoon/anime
}
```

The issue: cartoon/anime are not stored in DB as mediaType, they're stored differently (need to check schema).

Options to fix:
1. Check Prisma schema to understand how cartoon/anime are stored
2. For cartoon: mediaType might be 'movie' + additional classification (check TMDB or genre)
3. For anime: same approach - check how anime is classified in DB

Look at the existing classification logic in the file - there should be a function that determines mediaType from TMDB data. Use that same logic for filtering.

The fix approach:
- Instead of filtering at DB level, fetch ALL watched records and filter in-memory using the same classification logic that typeBreakdown uses
- This ensures consistency with typeBreakdown results
- Or: Add proper database-level filtering if cartoon/anime are stored with specific values

Read the file, understand the classification, implement proper filtering.
  </action>
  <verify>
getMediaTypeCondition returns proper filter for all 4 types, OR filtering happens in-memory with correct results
  </verify>
  <done>API correctly filters all stats by content type (movie, tv, cartoon, anime)</done>
</task>

<task type="auto">
  <name>Verify filtering works end-to-end</name>
  <files>src/app/api/user/stats/route.ts</files>
  <action>
1. Run npm run lint to check for errors
2. Verify the API logic is consistent - when filtering by cartoon, averageRating should be calculated only from cartoon entries
  </action>
  <verify>npm run lint passes</verify>
  <done>Lint passes, filtering logic verified</done>
</task>

</tasks>

<verification>
- [ ] getMediaTypeCondition handles cartoon/anime properly
- [ ] averageRating filters correctly for all 4 types
- [ ] ratingDistribution filters correctly for all 4 types
- [ ] typeBreakdown remains consistent with other stats
</verification>

<success_criteria>
API filtering works for all content types - when user clicks on any card (Фильмы, Сериалы, Мультфильмы, Аниме), the displayed stats (averageRating, ratingDistribution, etc.) are filtered to show only that content type.
</success_criteria>

<output>
After completion, create `.planning/phases/06-stats-page/06-03-SUMMARY.md`
</output>
