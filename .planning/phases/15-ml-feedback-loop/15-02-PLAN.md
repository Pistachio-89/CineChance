---
phase: 15-ml-feedback-loop
plan: '02'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/my-movies/route.ts
  - src/app/api/recommendations/ml-stats/route.ts
autonomous: true
gap_closure: true
requirements: []

must_haves:
  truths:
    - "When user adds recommended movie to list, outcome is tracked"
    - "ML stats endpoint returns outcome metrics in format expected by MLDashboard"
  artifacts:
    - path: "src/app/api/my-movies/route.ts"
      provides: "Import trackOutcome for runtime tracking"
    - path: "src/app/api/recommendations/ml-stats/route.ts"
      provides: "Legacy format compatible with MLDashboard component"
---

<objective>
Fix runtime errors and format mismatches from Phase 15 verification gaps.

Purpose: Close the two blocking issues found during verification:
1. Missing import causing runtime errors when tracking outcomes
2. Format mismatch between ML stats API and MLDashboard component

Output: Working outcome tracking and display
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-ml-feedback-loop/15-01-SUMMARY.md
@.planning/phases/15-ml-feedback-loop/15-VERIFICATION.md
@src/app/api/my-movies/route.ts
@src/app/api/recommendations/ml-stats/route.ts
@src/app/components/MLDashboard.tsx
@src/lib/recommendation-outcome-tracking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing trackOutcome import</name>
  <files>src/app/api/my-movies/route.ts</files>
  <action>
Add import statement for trackOutcome function from recommendation-outcome-tracking library.

The function is already called at lines 561 and 615 but is NOT imported, causing runtime errors.

Add after line 8 (after logger import):
```typescript
import { trackOutcome } from '@/lib/recommendation-outcome-tracking';
```
  </action>
  <verify>
Grep for "trackOutcome" import in my-movies/route.ts - should find the import statement
  </verify>
  <done>
Import statement present, runtime error for trackOutcome resolved
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix ML stats API response format</name>
  <files>src/app/api/recommendations/ml-stats/route.ts</files>
  <action>
Update ml-stats API to return format expected by MLDashboard component.

The component expects:
```typescript
interface MLStatsData {
  overview: {
    totalRecommendations: number;
    totalShown: number;
    totalAddedToWant: number;
    totalWatched: number;
    acceptanceRate: number;
    wantRate: number;
    watchRate: number;
  };
  algorithmPerformance: Record<string, {
    total: number;
    success: number;
    failure: number;
    successRate: number;
  }>;
  userSegments: { coldStart, activeUsers, heavyUsers };
  discrepancy: { predicted, actual, accuracy };
  corrections: { active, pending };
}
```

Update the GET handler to:
1. Use outcome stats from getOutcomeStats to calculate totalAddedToWant (sum of 'added' events) and totalWatched (sum of 'rated' events)
2. Calculate wantRate and watchRate as percentages
3. Map algorithm performance to expected format: { total, success, failure, successRate }
4. Add placeholder values for discrepancy and corrections (can be enhanced in future phases)
5. Add totalShown (recommendations shown = recommendation logs with shownAt)
  </action>
  <verify>
API returns JSON matching MLDashboard interface - verify by reading response structure
  </verify>
  <done>
ML stats API returns format compatible with MLDashboard component
  </done>
</task>

</tasks>

<verification>
Run lint to ensure no syntax errors:
```bash
npm run lint
```
</verification>

<success_criteria>
- [ ] trackOutcome imported in my-movies route
- [ ] ML stats API returns format matching MLDashboard interface
- [ ] No runtime errors when tracking outcomes
- [ ] Dashboard displays metrics correctly
</success_criteria>

<output>
After completion, create `.planning/phases/15-ml-feedback-loop/{phase}-02-SUMMARY.md`
</output>
