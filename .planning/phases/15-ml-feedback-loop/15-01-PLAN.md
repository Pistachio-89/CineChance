---
phase: 15-ml-feedback-loop
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/my-movies/route.ts
  - src/lib/recommendation-outcome-tracking.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "When user adds recommended movie to list, outcome is tracked"
    - "RecommendationLog entries update with user action (added, rated, ignored)"
    - "Outcome data is used to calculate algorithm performance metrics"
    - "Admin can view recommendation acceptance rate over time"
  artifacts:
    - path: "src/app/api/my-movies/route.ts"
      provides: "Outcome tracking when user acts on recommendation"
      contains: "recommendationLogId"
    - path: "src/lib/recommendation-outcome-tracking.ts"
      provides: "Outcome tracking logic"
      exports: ["trackOutcome", "calculateAcceptanceRate"]
  key_links:
    - from: "src/app/api/my-movies/route.ts"
      to: "RecommendationLog"
      via: "recommendation-outcome-tracking"
      pattern: "trackOutcome"
---

<objective>
Complete the ML feedback loop by tracking user outcomes when they act on recommendations, and using that data to measure algorithm performance.
</objective>

<context>
@.planning/ROADMAP.md
@src/app/api/recommendations/patterns/route.ts
@src/app/api/my-movies/route.ts
</context>

<tasks>

<task type="auto">
  <name>Create outcome tracking module</name>
  <files>src/lib/recommendation-outcome-tracking.ts</files>
  <action>
    Create a module for tracking recommendation outcomes:
    1. Create `recommendation-outcome-tracking.ts`
    2. Implement `trackOutcome(params)` function that:
       - Takes: recommendationLogId, action (added/rated/ignored), userRating (optional)
       - Updates RecommendationLog entry with outcome data
       - Records timestamp of outcome
    3. Implement `calculateAcceptanceRate(userId, algorithm?)` function:
       - Returns percentage of recommendations user acted on
       - Can filter by algorithm
    4. Implement `getAlgorithmPerformance()` function:
       - Returns performance metrics per algorithm
       - Based on acceptance rates from outcome data
  </action>
  <verify>
    - Run `npm run lint` passes
    - Functions are properly typed
  </verify>
  <done>
    Outcome tracking module created with trackOutcome, calculateAcceptanceRate, getAlgorithmPerformance
  </done>
</task>

<task type="auto">
  <name>Integrate outcome tracking into my-movies API</name>
  <files>src/app/api/my-movies/route.ts</files>
  <action>
    Update the my-movies API to track outcomes when user adds/rates a movie:
    1. Check if the movie being added was from a recommendation (look for recommendationLogId in request)
    2. If recommendationLogId present, call trackOutcome() with action "added"
    3. If user provides rating, call trackOutcome() with action "rated" and the rating
    4. Store the recommendationLogId reference for future outcome tracking
    
    The request already accepts recommendationLogId - verify it works and add outcome tracking.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Test adding a movie with recommendationLogId
  </verify>
  <done>
    User actions on recommendations are tracked as outcomes
  </done>
</task>

<task type="auto">
  <name>Update ML stats to show outcome metrics</name>
  <files>src/app/api/recommendations/ml-stats/route.ts</files>
  <action>
    Enhance the ML stats endpoint to include outcome metrics:
    1. Add acceptance rate to the response (overall and per-algorithm)
    2. Show breakdown: shown → added → rated
    3. Calculate algorithm performance based on outcomes
    4. Display trends over time (last 7/30 days)
  </action>
  <verify>
    - Run `npm run lint` passes
    - ML stats shows outcome metrics
  </verify>
  <done>
    ML Dashboard shows recommendation acceptance metrics
  </done>
</task>

</tasks>

<verification>
- Run `npm run lint` - no errors
- Test adding movie with recommendationLogId: outcome tracked
- Access /admin/monitoring: see acceptance metrics
</verification>

<success_criteria>
- [ ] User actions on recommendations are tracked as outcomes
- [ ] Outcome data shows in ML stats endpoint
- [ ] Admin can see acceptance rate per algorithm
</success_criteria>

<output>
After completion, create `.planning/phases/15-ml-feedback-loop/15-01-SUMMARY.md`
</output>
