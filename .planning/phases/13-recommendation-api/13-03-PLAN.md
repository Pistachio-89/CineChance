---
phase: 13-recommendation-api
plan: '03'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/recommendation-algorithms/types.ts
  - src/app/api/recommendations/patterns/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Heavy users (500+ watched) queries sample to 200 most recent items"
    - "Sampling info passed from route to algorithms via RecommendationSession"
    - "Heavy user metadata reflects actual sampling was applied"
  artifacts:
    - path: "src/lib/recommendation-algorithms/types.ts"
      provides: "Sampling config in RecommendationSession"
      contains: "sampleSize"
    - path: "src/app/api/recommendations/patterns/route.ts"
      provides: "Heavy user sampling logic"
      contains: "sampleSize"
  key_links:
    - from: "src/app/api/recommendations/patterns/route.ts"
      to: "src/lib/recommendation-algorithms/types.ts"
      via: "sessionData.sampleSize"
      pattern: "sampleSize"
---

<objective>
Implement actual sampling logic for heavy users (500+ watched items). Currently the route detects heavy users and reports metadata, but doesn't actually sample queries to 200 items. This gap closure adds sampling to the algorithms.
</objective>

<context>
@.planning/phases/13-recommendation-api/13-VERIFICATION.md
@src/lib/recommendation-algorithms/types.ts
@src/app/api/recommendations/patterns/route.ts
</context>

<tasks>

<task type="auto">
  <name>Add sampling config to RecommendationSession</name>
  <files>src/lib/recommendation-algorithms/types.ts</files>
  <action>
    Add sampling configuration to RecommendationSession interface:
    1. Add optional `sampleSize?: number` field to RecommendationSession
    2. Add optional `isHeavyUser?: boolean` field to track heavy user status
    
    This allows the route to pass sampling parameters to algorithms.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Check RecommendationSession interface includes new fields
  </verify>
  <done>
    RecommendationSession supports sampleSize parameter
  </done>
</task>

<task type="auto">
  <name>Pass sampling info from route to algorithms</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Modify the route to pass heavy user sampling info to algorithms:
    1. In the sessionData creation, add:
       - If isHeavyUser: set sessionData.sampleSize = 200
       - Set sessionData.isHeavyUser = true
    2. This passes the sampling limit to all algorithms via the session object
    
    Keep existing heavyUser metadata in response unchanged.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Check sessionData includes sampleSize for heavy users
  </verify>
  <done>
    Route passes sampleSize=200 to algorithms for heavy users
  </done>
</task>

<task type="auto">
  <name>Verify algorithms can use sampleSize</name>
  <files>src/lib/recommendation-algorithms/types.ts</files>
  <action>
    Document that algorithms can access sessionData.sampleSize:
    - Add JSDoc comment explaining sampleSize usage
    - Note that algorithms should use take: session.sampleSize when querying user data if sampleSize is set
    
    No need to modify all 8 algorithms - just document the pattern.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Check JSDoc comments added
  </verify>
  <done>
    Pattern documented for algorithms to respect sampleSize
  </done>
</task>

</tasks>

<verification>
- Run `npm run lint` - no errors
- Run `npm run test:ci` - tests pass
- Verify sessionData.sampleSize is set for heavy users
</verification>

<success_criteria>
- [ ] RecommendationSession includes sampleSize field
- [ ] Route passes sampleSize=200 for heavy users
- [ ] Heavy user metadata reflects sampling applied
</success_criteria>

<output>
After completion, create `.planning/phases/13-recommendation-api/13-03-SUMMARY.md`
</output>
