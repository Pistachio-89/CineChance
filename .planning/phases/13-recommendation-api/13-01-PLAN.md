---
phase: 13-recommendation-api
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/recommendations/patterns/route.ts
  - src/lib/recommendation-types.ts
  - src/middleware/rateLimit.ts
autonomous: true
requirements:
  - REC-API-01
  - REC-API-02

must_haves:
  truths:
    - "GET /api/recommendations returns recommendations for authenticated users"
    - "Cold start users (<10 watched) receive TMDB trending/popular fallback"
    - "Rate limiting protects the endpoint from abuse"
    - "Request returns within 5 seconds or uses cached results"
  artifacts:
    - path: "src/app/api/recommendations/patterns/route.ts"
      provides: "Main recommendation API endpoint"
      exports: ["GET"]
      min_lines: 300
    - path: "src/lib/recommendation-types.ts"
      provides: "Confidence scoring types"
      contains: "ConfidenceScore"
  key_links:
    - from: "src/app/api/recommendations/patterns/route.ts"
      to: "src/lib/recommendation-algorithms"
      via: "recommendationAlgorithms.execute()"
      pattern: "algorithm\\.execute"
    - from: "src/app/api/recommendations/patterns/route.ts"
      to: "src/middleware/rateLimit"
      via: "rateLimit()"
      pattern: "rateLimit.*recommendations"
---

<objective>
Create the main Recommendation API endpoint with cold start handling. The existing `/api/recommendations/patterns` endpoint already implements most functionality, but this plan ensures it's properly documented as the main endpoint and adds caching for performance.
</objective>

<context>
@.planning/ROADMAP.md
@src/app/api/recommendations/patterns/route.ts
@src/lib/recommendation-algorithms.ts
</context>

<tasks>

<task type="auto">
  <name>Add Redis caching to recommendation endpoint</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Add Redis caching to the GET endpoint:
    1. Import { redis } from '@/lib/redis'
    2. Generate cache key: `recs:${userId}:${hash of request params}`
    3. Check cache before running algorithms, return cached if exists (TTL: 15 minutes)
    4. Store results in Redis after generation
    5. Add cache headers to response (X-Cache: HIT/MISS)
    
    Note: Keep existing cold start logic unchanged.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Test endpoint with curl, verify X-Cache header appears
  </verify>
  <done>
    Recommendations endpoint returns cached results on subsequent requests within 15 minutes
  </done>
</task>

<task type="auto">
  <name>Add request timeout and abort logic</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Add timeout protection to prevent long-running requests:
    1. Add AbortController for each algorithm execution
    2. Set 3-second timeout per algorithm
    3. Log timeout warnings but continue with other algorithms
    4. Add timeout metrics to response meta
    
    This ensures graceful behavior even with slow algorithms.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Check response includes timeout metrics in meta
  </verify>
  <done>
    No request hangs indefinitely; timeout metrics visible in response
  </done>
</task>

<task type="auto">
  <name>Add cold start metadata to response</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Enhance response metadata for cold start users:
    1. Add `coldStart: { threshold: number, fallbackSource: string }` to meta
    2. Add `watchedCount` to meta for debugging
    3. Document cold start threshold as 10 watched items
    
    Ensure client can display appropriate messaging for cold start users.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Test with user having <10 watched items, verify coldStart in response
  </verify>
  <done>
    Cold start users receive fallback metadata in response
  </done>
</task>

</tasks>

<verification>
- Run `npm run lint` - no errors
- Test endpoint: `curl -H "Cookie: ..." http://localhost:3000/api/recommendations/patterns`
- Verify cold start fallback works for new users
</verification>

<success_criteria>
- [ ] GET /api/recommendations/patterns returns recommendations for authenticated users
- [ ] Cold start users (<10 watched) get TMDB trending/popular fallback
- [ ] Response includes cache headers and cached results work
- [ ] Request timeouts don't hang indefinitely
</success_criteria>

<output>
After completion, create `.planning/phases/13-recommendation-api/13-01-SUMMARY.md`
</output>
