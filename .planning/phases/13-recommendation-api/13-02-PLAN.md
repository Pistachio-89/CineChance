---
phase: 13-recommendation-api
plan: '02'
type: execute
wave: 2
depends_on:
  - '13-01'
files_modified:
  - src/app/api/recommendations/patterns/route.ts
  - src/lib/recommendation-types.ts
  - src/lib/recommendation-algorithms.ts
autonomous: true
requirements:
  - REC-API-03
  - REC-API-04
  - REC-API-05

must_haves:
  truths:
    - "Heavy users (500+ watched) get optimized processing with sampling"
    - "Failed algorithms don't crash the entire request"
    - "Each recommendation includes confidence score (0-100)"
    - "Response includes per-algorithm success/failure status"
  artifacts:
    - path: "src/app/api/recommendations/patterns/route.ts"
      provides: "Heavy user optimization + graceful degradation"
      contains: "HEAVY_USER_THRESHOLD"
    - path: "src/lib/recommendation-types.ts"
      provides: "ConfidenceScore interface"
      contains: "ConfidenceScore"
  key_links:
    - from: "src/app/api/recommendations/patterns/route.ts"
      to: "src/lib/recommendation-types.ts"
      via: "ConfidenceScore"
      pattern: "confidence.*score"
---

<objective>
Add heavy user handling, graceful degradation, and confidence scoring to the recommendation API. This ensures the system handles users with large watchlists efficiently and provides quality signals to the UI.
</objective>

<context>
@.planning/phases/13-recommendation-api/13-01-PLAN.md
@src/app/api/recommendations/patterns/route.ts
@src/lib/recommendation-algorithms/types.ts
</context>

<tasks>

<task type="auto">
  <name>Add heavy user optimization with sampling</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Optimize for users with large watchlists (500+ items):
    1. Add HEAVY_USER_THRESHOLD constant = 500
    2. For heavy users:
       - Sample most recent 200 watched items for similarity calculations
       - Use cached TasteMap data (don't recompute)
       - Add `isHeavyUser: true` to meta when sampled
    3. Log heavy user detection for monitoring
    
    This prevents slow queries for power users.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Create user with 500+ watched items, verify sampling kicks in
  </verify>
  <done>
    Heavy users receive recommendations without timeout
  </done>
</task>

<task type="auto">
  <name>Add graceful degradation for algorithm failures</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    Ensure request succeeds even if individual algorithms fail:
    1. Wrap each algorithm.execute() in try/catch
    2. Track per-algorithm success/failure in `algorithmsStatus` object
    3. Add `algorithmsStatus: { [name]: { success: boolean, error?: string } }` to meta
    4. Continue processing remaining algorithms if one fails
    5. Return partial results with warning if some algorithms failed
    
    Current code already has try/catch - enhance it to track status.
  </action>
  <verify>
    - Run `npm run lint` passes
    - Test with simulated algorithm failure, verify partial results returned
  </verify>
  <done>
    Request returns results even if some algorithms fail
  </done>
</task>

<task type="auto">
  <name>Add confidence scoring to recommendations</name>
  <files>src/lib/recommendation-types.ts</files>
  <action>
    Add confidence scoring to indicate recommendation quality:
    1. Add ConfidenceScore interface to types:
       ```typescript
       export interface ConfidenceScore {
         value: number; // 0-100
         factors: {
           algorithmCount: number;
           similarUsersFound: number;
           scoreVariance: number;
           isColdStart: boolean;
           isHeavyUser: boolean;
         };
       }
       ```
    2. Calculate confidence in patterns route:
       - Base: 50 + (algorithmCount * 5), max 90
       - Similar users: +10 if 5+ found
       - Variance: -20 if high variance (std dev > 20)
       - Cold start: -30 (lower confidence)
       - Heavy user sampling: -10 (sampling = less data)
    3. Add confidence to response meta
  </action>
  <verify>
    - Run `npm run lint` passes
    - Test endpoint, verify confidence in response
  </verify>
  <done>
    Each recommendation response includes confidence score
  </done>
</task>

</tasks>

<verification>
- Run `npm run lint` - no errors
- Test with regular user: verify confidence factors present
- Test with cold start user: verify lower confidence
- Test with heavy user: verify isHeavyUser flag
</verification>

<success_criteria>
- [ ] Heavy users (500+) get optimized processing
- [ ] Algorithm failures don't crash request
- [ ] Response includes confidence score with factors
- [ ] Response includes per-algorithm status
</success_criteria>

<output>
After completion, create `.planning/phases/13-recommendation-api/13-02-SUMMARY.md`
</output>
