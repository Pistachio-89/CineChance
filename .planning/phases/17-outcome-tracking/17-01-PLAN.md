---
phase: 17-outcome-tracking
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/recommendations/patterns/route.ts
  - src/app/components/RecommendationsGrid.tsx
  - src/app/api/watchlist/route.ts
  - src/app/components/MovieCard.tsx
autonomous: true
gap_closure: true
requirements: []

must_haves:
  truths:
    - "User can add a movie from home page recommendations"
    - "When movie is added, recommendationLogId is passed to watchlist API"
    - "Outcome tracking works for home page recommendations"
  artifacts:
    - path: "src/app/api/recommendations/patterns/route.ts"
      provides: "API returns logIds in response"
      contains: "logIds"
    - path: "src/app/components/RecommendationsGrid.tsx"
      provides: "Captures and stores logIds in localStorage"
      contains: "localStorage"
    - path: "src/app/api/watchlist/route.ts"
      provides: "Accepts and tracks recommendationLogId"
      contains: "trackOutcome"
  key_links:
    - from: "src/app/api/recommendations/patterns/route.ts"
      to: "RecommendationsGrid.tsx"
      via: "API response includes logIds"
      pattern: "logIds.*response"
    - from: "RecommendationsGrid.tsx"
      to: "localStorage"
      via: "useEffect stores logId mapping"
      pattern: "rec_logid_map"
    - from: "MovieCard.tsx"
      to: "/api/watchlist"
      via: "handleSaveRating passes recommendationLogId"
      pattern: "recommendationLogId"
    - from: "/api/watchlist"
      to: "recommendationLog"
      via: "trackOutcome function"
      pattern: "trackOutcome"
---

<objective>
Enable outcome tracking from main page recommendations by capturing and passing recommendationLogId to my-movies API.
</objective>

<context>
@.planning/ROADMAP.md

# Understanding the current flow:
# 1. /recommendations page uses RecommendationsClient -> /api/recommendations/random -> returns logId -> passes to my-movies API (WORKS)
# 2. Home page uses RecommendationsGrid -> /api/recommendations/patterns -> returns NO logIds -> cannot track outcomes (BROKEN)

# Key files:
@src/app/api/recommendations/patterns/route.ts
@src/app/components/RecommendationsGrid.tsx
@src/app/api/watchlist/route.ts (needs to accept recommendationLogId)
@src/app/components/MovieCard.tsx (needs to pass recommendationLogId from localStorage)
@src/app/api/my-movies/route.ts (lines 561-571 - reference for trackOutcome)
</context>

<tasks>

<task type="auto">
  <name>Modify patterns API to return logIds in response</name>
  <files>src/app/api/recommendations/patterns/route.ts</files>
  <action>
    1. Modify the logRecommendations function to return the created logIds (change return type from void to Promise&lt;string[]&gt;)
    2. Update the GET handler to capture these logIds and include them in the response
    3. Add logIds array to the response alongside recommendations, mapping each recommendation to its corresponding logId by index

    The response should look like:
    {
      success: true,
      recommendations: [...],
      logIds: ["uuid1", "uuid2", ...],  // NEW - array of logIds matching recommendations array
      meta: {...}
    }
  </action>
  <verify>API response includes logIds array when calling /api/recommendations/patterns</verify>
  <done>/api/recommendations/patterns returns logIds array matching recommendations order</done>
</task>

<task type="auto">
  <name>Capture logIds in RecommendationsGrid and pass to my-movies API</name>
  <files>src/app/components/RecommendationsGrid.tsx</files>
  <action>
    1. Add state to store logIds: const [logIds, setLogIds] = useState&lt;string[]&gt;([])
    2. After fetching recommendations, also store the logIds from response
    3. Store logIds in localStorage with key "homepage_rec_logIds" as JSON stringified array
    4. Modify the MovieCard to accept an optional recommendationLogId prop
    5. When rendering MovieCard for each recommendation, pass the corresponding logId from the logIds array

    Note: The MovieCard doesn't directly call my-movies API - it shows a modal. The recommendationLogId needs to be passed through the modal flow. A simpler approach:
    - Store logIds in localStorage keyed by tmdbId: { "123": "uuid-123", "456": "uuid-456" }
    - The my-movies API or its caller can look up the logId from localStorage before calling the API

    Implementation:
    - Add useEffect to store logIds in localStorage as JSON object { [tmdbId]: logId }
    - Use recommendationToMedia to convert and pass data, but the logId needs different handling
    - Store mapping in localStorage under "rec_logid_map"
  </action>
  <verify>logIds are stored in localStorage when recommendations load</verify>
  <done>RecommendationsGrid stores logId mapping in localStorage for lookup when adding movies</done>
</task>

<task type="auto">
  <name>Modify watchlist API to accept and track recommendationLogId</name>
  <files>src/app/api/watchlist/route.ts</files>
  <action>
    1. Modify the POST handler to accept optional recommendationLogId parameter in the request body
    2. When status is 'watched' or 'rewatched' and recommendationLogId is provided:
       - Import trackOutcome from @/lib/recommendation-outcome-tracking
       - Call trackOutcome with recommendationLogId and action 'added'
       - This is the same pattern used in /api/my-movies route.ts (lines 561-571)
    3. Also save recommendationLogId to the RewatchLog if creating a new watch entry

    Reference the pattern from my-movies route.ts:
    ```typescript
    if (recommendationLogId) {
      await trackOutcome({
        recommendationLogId,
        action: 'added',
      });
    }
    ```
  </action>
  <verify>/api/watchlist accepts recommendationLogId and tracks outcome when provided</verify>
  <done>watchlist API tracks recommendation outcomes when recommendationLogId is passed</done>
</task>

<task type="auto">
  <name>Modify MovieCard to lookup and pass recommendationLogId</name>
  <files>src/app/components/MovieCard.tsx</files>
  <action>
    1. In handleSaveRating function (around line 277), before calling /api/watchlist:
       - Check localStorage for "rec_logid_map" 
       - Parse the JSON to get { [tmdbId]: logId } mapping
       - If the current movie's tmdbId has a logId, add it to the request body
    
    2. The same pattern should be applied to other places that call /api/watchlist:
       - handleStatusChange function (line 324)
       - Any other locations that call /api/watchlist

    Example implementation:
    ```typescript
    // Get recommendationLogId from localStorage if available
    let recommendationLogId: string | undefined;
    if (typeof window !== 'undefined') {
      try {
        const logIdMap = JSON.parse(localStorage.getItem('rec_logid_map') || '{}');
        recommendationLogId = logIdMap[String(movie.id)];
      } catch (e) {
        // Ignore parse errors
      }
    }

    // Add to request body
    body: JSON.stringify({
      tmdbId: movie.id,
      mediaType: movie.media_type,
      // ...other fields
      recommendationLogId, // Only included if defined
    })
    ```
  </action>
  <verify>MovieCard passes recommendationLogId to /api/watchlist when available in localStorage</verify>
  <done>MovieCard looks up and passes recommendationLogId when adding movies from home page</done>
</task>

</tasks>

<verification>
1. Call /api/recommendations/patterns - verify response includes logIds array
2. Load home page - verify localStorage has rec_logid_map with tmdbId->logId mapping
3. Click a recommendation movie card, mark as watched - verify my-movies API receives recommendationLogId
4. Check database - verify outcome is tracked in recommendationLog
</verification>

<success_criteria>
- [ ] /api/recommendations/patterns returns logIds in response
- [ ] RecommendationsGrid stores logId mapping in localStorage
- [ ] MovieCard passes recommendationLogId when adding movies from home page
- [ ] /api/watchlist tracks outcome when recommendationLogId is provided
- [ ] Outcome tracking works for home page recommendations (same as /recommendations page)
</success_criteria>

<output>
After completion, create `.planning/phases/17-outcome-tracking/17-01-SUMMARY.md`
</output>
