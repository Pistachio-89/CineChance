---
phase: 16-ml-stats-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/recommendations/ml-stats/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unauthenticated requests to /api/recommendations/ml-stats return 401"
    - "Authenticated requests to /api/recommendations/ml-stats return ML statistics"
  artifacts:
    - path: "src/app/api/recommendations/ml-stats/route.ts"
      provides: "ML statistics API with authentication"
      contains: "getServerSession"
  key_links:
    - from: "src/app/api/recommendations/ml-stats/route.ts"
      to: "@/auth"
      via: "import authOptions"
      pattern: "getServerSession.*authOptions"
---

<objective>
Add authentication check to unprotected ML stats API endpoint

Purpose: Close security gap identified in v2.0 audit - ML statistics endpoint was accessible without authentication

Output: Protected /api/recommendations/ml-stats endpoint
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference for authentication pattern
@src/app/api/recommendations/patterns/route.ts (lines 287-290)
</context>

<tasks>

<task type="auto">
  <name>Add session authentication check to ml-stats endpoint</name>
  <files>src/app/api/recommendations/ml-stats/route.ts</files>
  <action>
    Add session authentication check to the GET endpoint in src/app/api/recommendations/ml-stats/route.ts

    1. Add imports at the top of the file:
       - import { getServerSession } from 'next-auth';
       - import { authOptions } from '@/auth';

    2. Add session check AFTER the rate limit check (line 19), BEFORE any data fetching:
       ```typescript
       // Check authentication
       const session = await getServerSession(authOptions);
       if (!session?.user?.id) {
         return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
       }
       ```

    Pattern reference: src/app/api/recommendations/patterns/route.ts lines 287-290

    IMPORTANT: Place the auth check AFTER rate limiting (as per rate-limiting-architecture-failures.md patterns)
  </action>
  <verify>
    # Verify authentication is added
    grep -n "getServerSession" src/app/api/recommendations/ml-stats/route.ts
    # Should return the import line

    # Verify the session check
    grep -n "session?.user?.id" src/app/api/recommendations/ml-stats/route.ts
    # Should return the check with 401 response
  </verify>
  <done>
    - File has getServerSession import from next-auth
    - File has authOptions import from @/auth
    - Session check returns 401 for unauthenticated requests
    - Endpoint functions normally for authenticated users
  </done>
</task>

</tasks>

<verification>
- [ ] Import statements added: getServerSession from 'next-auth', authOptions from '@/auth'
- [ ] Session check placed after rate limit check
- [ ] Returns 401 Unauthorized when no session exists
- [ ] No existing functionality broken (rate limiting still works)
</verification>

<success_criteria>
GET /api/recommendations/ml-stats without authentication returns 401 with {error: 'Unauthorized'}
GET /api/recommendations/ml-stats with valid session returns 200</success_criteria>

<output>
After completion with ML statistics
, create `.planning/phases/16-ml-stats-security/16-01-SUMMARY.md`
</output>
