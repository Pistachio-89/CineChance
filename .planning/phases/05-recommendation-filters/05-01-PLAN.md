---
phase: 05-recommendation-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/recommendations/FilterForm.tsx
  - prisma/schema.prisma
  - src/app/api/user/settings/route.ts
  - src/app/profile/settings/SettingsClient.tsx
  - src/app/recommendations/page.tsx
autonomous: true
requirements:
  - FILTER-01
  - FILTER-02
user_setup: []

must_haves:
  truths:
    - "Button text shows 'Мульты' instead of 'Мульт' on Recommendations page"
    - "User can toggle content types in Settings (Фильмы, Сериалы, Аниме, Мульты)"
    - "Content type preferences persist to database across sessions"
    - "Recommendations page uses saved content type preferences as initial filter values"
  artifacts:
    - path: "src/app/recommendations/FilterForm.tsx"
      provides: "Content type filter buttons with correct Russian labels"
      contains: "Мульты"
    - path: "prisma/schema.prisma"
      provides: "RecommendationSettings model with content type fields"
      contains: "includeMovie, includeTv, includeAnime, includeCartoon"
    - path: "src/app/api/user/settings/route.ts"
      provides: "API endpoint to save/load content type preferences"
      contains: "includeMovie, includeTv, includeAnime, includeCartoon"
    - path: "src/app/profile/settings/SettingsClient.tsx"
      provides: "Settings UI with content type toggles"
      contains: "content type toggles similar to list toggles"
  key_links:
    - from: "SettingsClient.tsx"
      to: "/api/user/settings"
      via: "fetch PUT with JSON body"
      pattern: "includeMovie.*includeTv.*includeAnime.*includeCartoon"
    - from: "recommendations/page.tsx"
      to: "/api/user/settings"
      via: "fetch GET, pass to FilterForm initialTypes"
      pattern: "initialTypes.*settings"
---

<objective>
Implement two enhancements for recommendation filters: (1) rename "Мульт" to "Мульты" in Recommendations page, and (2) add content type filters to User Settings page that persist to database and link with recommendation filters.
</objective>

<execution_context>
@C:/Users/n0rds/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/n0rds/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
# Reference existing patterns

## List filter toggles pattern (from SettingsClient.tsx)
- Use boolean state: `const [includeMovie, setIncludeMovie] = useState(true)`
- Toggle handler prevents disabling all options: `if (enabledCount > 1) setIncludeMovie(false)`
- Save to API: `fetch('/api/user/settings', { method: 'PUT', body: JSON.stringify({ includeMovie, ... }) })`
- Load on mount: `fetch('/api/user/settings')` and set state from response

## FilterForm initialTypes pattern (from FilterForm.tsx)
- Initial types passed as prop: `initialTypes = ['movie', 'tv', 'anime', 'cartoon']`
- Used in useState: `useState<ContentType[]>(initialTypes)`
- Page passes settings values to FilterForm: `initialTypes={enabledTypes}`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename "Мульт" to "Мульты" in FilterForm</name>
  <files>src/app/recommendations/FilterForm.tsx</files>
  <action>
Change the button text from "Мульт" to "Мульты" on line 266 of FilterForm.tsx.
The button is the fourth content type button in the filter form (cartoon type).
This is a simple text change - no other logic changes needed.
  </action>
  <verify>
grep -n "Мульт" src/app/recommendations/FilterForm.tsx
Expected: Only "Мульты" appears, no "Мульт"
  </verify>
  <done>Button text displays "Мульты" on Recommendations page filter form</done>
</task>

<task type="auto">
  <name>Task 2: Add content type filters to Settings and database</name>
  <files>
    - prisma/schema.prisma
    - src/app/api/user/settings/route.ts
    - src/app/profile/settings/SettingsClient.tsx
    - src/app/recommendations/page.tsx
  </files>
  <action>
**Step 2.1 - Database Schema:**
Add 4 new boolean fields to RecommendationSettings model in prisma/schema.prisma:
- includeMovie Boolean @default(true)
- includeTv Boolean @default(true)
- includeAnime Boolean @default(true)  
- includeCartoon Boolean @default(true)

Run `npx prisma migrate dev --name add_content_type_filters` to apply changes.

**Step 2.2 - API Route:**
Update /api/user/settings/route.ts to:
- Add includeMovie, includeTv, includeAnime, includeCartoon to GET response
- Add validation for new boolean fields in PUT
- Add new fields to upsert in PUT (update and create)
- Add new fields to logger output

**Step 2.3 - Settings UI:**
Update SettingsClient.tsx to add content type toggles:
- Add state: includeMovie, includeTv, includeAnime, includeCartoon (all default true)
- Add fetch logic in fetchSettings() to load from API
- Add toggle handlers (same pattern as list toggles - prevent disabling all)
- Add 4 toggle buttons in UI (similar styling to list toggles)
- Add new fields to handleSaveSettings() body

**Step 2.4 - Link to Recommendations:**
Update recommendations/page.tsx to:
- Fetch user settings on page load
- Extract enabled content types: if includeMovie→'movie', includeTv→'tv', includeAnime→'anime', includeCartoon→'cartoon'
- Pass as initialTypes prop to FilterForm component
  </action>
  <verify>
1. Database migration created and applied
2. API returns new fields: curl http://localhost:3000/api/user/settings (authenticated)
3. Settings page shows 4 content type toggles
4. Saving settings persists to database
5. Recommendations page uses saved content types as initial filter selection
  </verify>
  <done>
- User can toggle content types in Settings (Фильмы, Сериалы, Аниме, Мульты)
- Settings persist to database across sessions
- Recommendations page uses saved preferences as default filter selection
  </done>
</task>

</tasks>

<verification>
- [ ] "Мульты" text appears in FilterForm.tsx
- [ ] Database has includeMovie, includeTv, includeAnime, includeCartoon fields
- [ ] API handles new fields for get and update
- [ ] Settings page has content type toggles matching list toggle pattern
- [ ] Recommendations page loads and uses saved content type preferences
</verification>

<success_criteria>
1. Filter button shows "Мульты" text (not "Мульт")
2. Settings page has toggles for Фильмы, Сериалы, Аниме, Мульты
3. User can save content type preferences in Settings
4. Saved preferences persist to database
5. Recommendations page uses saved preferences as initial filter values
</success_criteria>

<output>
After completion, create `.planning/phases/05-recommendation-filters/05-01-SUMMARY.md`
</output>
