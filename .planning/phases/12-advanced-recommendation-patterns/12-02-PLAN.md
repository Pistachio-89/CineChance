---
phase: 12-advanced-recommendation-patterns
plan: '02'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/recommendation-algorithms.ts
  - src/lib/recommendation-algorithms/person-twins.ts
  - src/lib/recommendation-algorithms/person-recommendations.ts
autonomous: true
requirements:
  - REC-07
  - REC-08

must_haves:
  truths:
    - User can receive recommendations based on users who share favorite actors/directors
    - User can see movies featuring their favorite actors and directors
    - Recommendations avoid recently shown items (7-day cooldown)
    - Cold start users with <10 watched movies receive fallback recommendations
  artifacts:
    - path: src/lib/recommendation-algorithms/person-twins.ts
      provides: Person Twins algorithm (Pattern 7)
      min_lines: 300
      exports: personTwins as IRecommendationAlgorithm
    - path: src/lib/recommendation-algorithms/person-recommendations.ts
      provides: Person Recommendations algorithm (Pattern 8)
      min_lines: 300
      exports: personRecommendations as IRecommendationAlgorithm
    - path: src/lib/recommendation-algorithms.ts
      provides: Algorithm exports updated with patterns 7-8
      contains: personTwins, personRecommendations
  key_links:
    - from: src/lib/recommendation-algorithms/person-twins.ts
      to: src/lib/taste-map/similarity.ts
      via: personOverlap function
      pattern: personOverlap.*actors.*directors
    - from: src/lib/recommendation-algorithms/person-recommendations.ts
      to: src/lib/taste-map/redis.ts
      via: getPersonProfile function
      pattern: getPersonProfile.*favoritePersons
---

<objective>
Implement Patterns 7-8: Person Twins and Person Recommendations

Purpose: Add person-based collaborative and content-based filtering. Person Twins finds users with similar favorite actors/directors, while Person Recommendations recommends movies featuring user's favorite persons directly.

Output: Two new recommendation algorithms exported from recommendation-algorithms.ts
</objective>

<context>
@src/lib/recommendation-algorithms/interface.ts
@src/lib/recommendation-algorithms/types.ts
@src/lib/taste-map/types.ts (PersonProfiles interface)
@src/lib/taste-map/similarity.ts (personOverlap function)
@src/lib/taste-map/redis.ts (getPersonProfile)

Reference Phase 11 patterns for architecture:
@src/lib/recommendation-algorithms/taste-match.ts
@src/lib/recommendation-algorithms/type-twins.ts
</context>

<tasks>

<task type="auto">
  <name>Create Person Twins algorithm (Pattern 7)</name>
  <files>src/lib/recommendation-algorithms/person-twins.ts</files>
  <action>
Create src/lib/recommendation-algorithms/person-twins.ts implementing IRecommendationAlgorithm:

1. Algorithm name: 'person_twins_v1', minUserHistory: 10
2. Use getPersonProfile() from taste-map/redis.ts to get user's person profile (actors + directors)
3. Use personOverlap() from taste-map/similarity.ts to find users with similar person preferences
4. Person overlap: combines Jaccard similarity for both actors and directors
5. Similarity threshold: 0.5, max 15 similar users
6. Candidate pool: fetch top-rated watched movies (rating >= 7) from person-similar users
7. Score formula: (personSimilarity * 0.5) + (rating * 0.3) + (cooccurrence * 0.2)
8. Apply cooldown filter (7 days via RecommendationLog)
9. Exclude user's existing watchlist items
10. Use normalizeScores() for 0-100 scale
11. Cold start fallback: return empty recommendations (handled by orchestration)
12. Log metrics: candidatesPoolSize, afterFilters, avgScore

Note: Need to query TMDB or cached credits to get movie cast/crew for filtering
  </action>
  <verify>
File created with exports matching IRecommendationAlgorithm interface
Passes TypeScript compilation: npx tsc --noEmit
Follows pattern structure from taste-match.ts
  </verify>
  <done>
Person Twins algorithm implemented: finds users with similar favorite actors/directors and recommends their highly-rated watched movies
</done>
</task>

<task type="auto">
  <name>Create Person Recommendations algorithm (Pattern 8)</name>
  <files>src/lib/recommendation-algorithms/person-recommendations.ts</files>
  <action>
Create src/lib/recommendation-algorithms/person-recommendations.ts implementing IRecommendationAlgorithm:

1. Algorithm name: 'person_recommendations_v1', minUserHistory: 5
2. Get user's person profile via getPersonProfile()
3. Extract favorite persons (top actors + directors with score >= 60)
4. Find similar users via getSimilarUsers() from taste-map/similarity.ts
5. For each similar user, fetch their watched movies featuring user's favorite persons
6. Candidate pool: movies with user's favorite actors/directors
7. Score formula: (personMatchScore * 0.4) + (rating * 0.4) + (userSimilarity * 0.2)
   - personMatchScore: how many favorite persons appear in the movie
8. Apply cooldown filter and exclude existing watchlist
9. Use normalizeScores() for 0-100 scale
10. Cold start fallback: return empty (orchestration handles popularity fallback)
11. Log metrics and return RecommendationResult
  </action>
  <verify>
File created with exports matching IRecommendationAlgorithm interface
Passes TypeScript compilation: npx tsc --noEmit
Follows pattern structure from type-twins.ts
  </verify>
  <done>
Person Recommendations algorithm implemented: recommends movies featuring user's favorite actors/directors
</done>
</task>

<task type="auto">
  <name>Export new algorithms from recommendation-algorithms.ts</name>
  <files>src/lib/recommendation-algorithms.ts</files>
  <action>
Update src/lib/recommendation-algorithms.ts:

1. Add imports for personTwins and personRecommendations
2. Add them to recommendationAlgorithms array (as patterns 7 and 8)
3. Export both algorithms
4. Update comment documenting all 8 patterns
  </action>
  <verify>
npm run lint passes
All algorithms properly exported and typed
  </verify>
  <done>
Algorithms exported and available for recommendation pipeline
</done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: npx tsc --noEmit
- Linting passes: npm run lint
- Both algorithms implement IRecommendationAlgorithm interface correctly
- Algorithms follow same architecture as Phase 11 patterns
</verification>

<success_criteria>
- Person Twins algorithm finds users with similar favorite actors/directors (person overlap >= 0.5)
- Person Recommendations algorithm uses user's favorite persons for recommendations
- Both use normalizeScores() for 0-100 scale
- Both apply 7-day cooldown filtering
- Cold start handled (returns empty, orchestration uses fallback)
- Metrics logged properly
</success_criteria>

<output>
After completion, create .planning/phases/12-advanced-recommendation-patterns/12-02-SUMMARY.md
</output>
